# Scanner Integration Guide

## Overview

This guide covers integrating the perplex (re2c-based) scanner with the lemon-generated Express parser. The scanner and parser must work together correctly.

## Expected Files

When scanner files are added, you should see:

- Scanner source (e.g., `scanner.re` or `scanner.c`)
- Token definitions that match parser tokens
- Scanner initialization and interface code
- Integration code that calls `Parse()`

## Scanner-Parser Interface

### Token Mapping

The scanner must produce token IDs that match those in `expparse.h`:

```c
// From expparse.h (generated by lemon)
#define TOK_IDENTIFIER 34
#define TOK_INTEGER 42
#define TOK_STRING 47
// ... etc

// Scanner must use these same constants
```

### Parser Invocation

The scanner typically calls the parser like this:

```c
#include "expparse.h"

void *parser = ParseAlloc(malloc);
parse_data_t parseData = { /* initialize */ };

// For each token scanned:
YYSTYPE token_value;
token_value./* set appropriate field */;

Parse(parser, token_id, token_value, parseData);

// At end of input:
Parse(parser, 0, token_value, parseData);  // 0 = EOF
ParseFree(parser, free);
```

## Checking Scanner Compatibility

### 1. Verify Token Definitions Match

```bash
# Extract token definitions from parser
grep "^#define TOK_" stepcode/expparse.h > parser_tokens.txt

# Extract token definitions from scanner
# (method depends on how scanner defines tokens)
grep "TOK_" scanner.c > scanner_tokens.txt

# Compare
# All tokens used by scanner must exist in parser
```

### 2. Check Token Values

The token ID values must match exactly:

```bash
# Generate with new lemon
./lemon stepcode/expparse.y

# Verify scanner still uses correct values
# If scanner has hardcoded values, they must match expparse.h
```

### 3. Verify ParseARG Usage

The grammar uses `%extra_argument { parse_data_t parseData }`.

Scanner must pass this argument:

```c
// Correct:
Parse(parser, token_id, token_value, parseData);

// Wrong (will not compile):
Parse(parser, token_id, token_value);
```

## Common Issues and Fixes

### Issue: Token ID Mismatch

**Symptom**: Parser doesn't recognize tokens from scanner

**Solution**: 
- Regenerate parser: `./lemon stepcode/expparse.y`
- Update scanner to include: `#include "expparse.h"`
- Remove any hardcoded token values from scanner
- Use token constants from expparse.h

### Issue: Wrong Function Signature

**Symptom**: Compilation error calling `Parse()`

**Solution**:
```c
// Old signature (if using old lemon):
void Parse(void *p, int token, YYSTYPE value, parse_data_t parseData);

// New signature (same, but ensure proper includes):
void Parse(void *p, int token, ParseTOKENTYPE value ParseARG_PDECL);

// Where ParseARG_PDECL expands to: , parse_data_t parseData
```

### Issue: YYSTYPE vs ParseTOKENTYPE

**Symptom**: Type mismatch errors

**Check**: 
```c
// In expparse.y:
%token_type { YYSTYPE }

// This makes ParseTOKENTYPE an alias for YYSTYPE
// So both are correct, but use ParseTOKENTYPE for clarity
```

## Scanner Updates That May Be Needed

### 1. Include Path Updates

If parser header location changes:

```c
// May need to update:
#include "expparse.h"
// to:
#include "stepcode/expparse.h"
```

### 2. Token Definition Updates

If using re2c, ensure token definitions are synchronized:

```c
// In scanner.re:
TOK_IDENTIFIER { return TOK_IDENTIFIER; }
TOK_INTEGER    { return TOK_INTEGER; }
// etc.

// These constants must come from expparse.h
```

### 3. Error Handling Updates

The parser uses `%syntax_error` directive. Ensure scanner errors are compatible:

```c
// Scanner error handling should be compatible with:
void syntax_error_handler() {
    // From %syntax_error in grammar
    ERRORreport_with_symbol(SYNTAX, &sym, "Syntax error",
        CURRENT_SCOPE_TYPE_PRINTABLE, CURRENT_SCOPE_NAME);
}
```

## Testing Scanner Integration

### Basic Test

```c
#include "expparse.h"
#include "scanner.h"
#include <stdio.h>

int main() {
    // Initialize parser
    void *parser = ParseAlloc(malloc);
    parse_data_t parseData = { /* init */ };
    
    // Initialize scanner
    scanner_init("test.exp");
    
    // Scan and parse
    int token;
    YYSTYPE value;
    while ((token = scan_next(&value)) != 0) {
        Parse(parser, token, value, parseData);
    }
    Parse(parser, 0, value, parseData);  // EOF
    
    // Cleanup
    ParseFree(parser, free);
    scanner_cleanup();
    
    printf("Parse complete\n");
    return 0;
}
```

### Token Stream Test

Log all tokens to verify scanner output:

```c
printf("Token: %d (", token);
switch(token) {
    case TOK_IDENTIFIER: printf("IDENTIFIER"); break;
    case TOK_INTEGER: printf("INTEGER"); break;
    // etc.
}
printf(")\n");
```

### Error Recovery Test

Test that syntax errors are handled properly:

```
// Test input with errors
test_bad.exp:
    ENTITY abc;  // Missing END_ENTITY
    
// Should trigger syntax error handler
```

## Perplex-Specific Considerations

### Re2c Token Generation

If using re2c to generate scanner:

```bash
# Regenerate scanner
re2c -o scanner.c scanner.re

# Verify it includes parser tokens
grep "expparse.h" scanner.c
```

### Perplex Configuration

Check perplex configuration for:

- Token ID mapping
- Include directives  
- Error handling callbacks
- State management

## Integration Checklist

When scanner files arrive:

- [ ] Verify scanner includes `expparse.h`
- [ ] Check token IDs match parser definitions
- [ ] Verify `Parse()` function signature is correct
- [ ] Test parse_data_t is passed correctly
- [ ] Check error handling is compatible
- [ ] Test with valid Express files
- [ ] Test with invalid input (error cases)
- [ ] Check for memory leaks
- [ ] Verify performance is acceptable
- [ ] Update build system if needed

## Performance Considerations

The new lemon generates more efficient parsers:

- 37% fewer states (403 vs 645)
- Shift-reduce optimizations
- Better action table compression

This should result in:
- Faster parsing
- Less memory usage  
- Better cache locality

Benchmark to confirm improvements:

```bash
time ./old_parser large_file.exp
time ./new_parser large_file.exp
```

## Debugging Tips

### Enable Parser Tracing

```c
#ifdef DEBUG
ParseTrace(stderr, "parser: ");
#endif
```

### Log Token Stream

```c
void log_token(int token, YYSTYPE value) {
    fprintf(stderr, "Token %d: ", token);
    // Print token details
    fprintf(stderr, "\n");
}
```

### Check State Transitions

Compare .out files from old and new lemon to understand state changes.

## Next Steps

1. Wait for scanner files to be added
2. Run integration tests
3. Fix any compatibility issues
4. Update build system
5. Run full regression suite
6. Document any scanner changes needed

## Questions to Answer

When scanner files arrive, verify:

1. Does scanner include expparse.h?
2. Are token IDs dynamically obtained or hardcoded?
3. Does scanner use YYSTYPE or ParseTOKENTYPE?
4. Is parse_data_t struct defined correctly?
5. Are ParseAlloc/ParseFree called properly?
6. Is error handling compatible?

## Support

If you encounter scanner integration issues:

1. Check this guide first
2. Verify parser works standalone (test_lemon.sh)
3. Test scanner separately from parser
4. Check token ID mapping
5. Enable debug output for both scanner and parser
6. Compare behavior with old lemon version
